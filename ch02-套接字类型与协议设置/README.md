# ch02 套接字类型与协议设置

## 1. 套接字协议及其数据传输特性

### *1. 创建套接字*

```c
int socket(int domain, int type, int protocol)
// 在域 DOMAIN 中创建类型为 TYPE 的新套接字，使用协议 PROTOCOL。
// 若 PROTOCOL 为零，则自动选择合适的协议。
// 返回新套接字的文件描述符，出错时返回 -1。
```

+ *domain* ：套接字中使用的协议族（Protocol Family）信息。
+ *type* ：套接字数据传输类型信息。
+ *protocol* ：计算机间通信使用的协议信息。

### *2. 协议族(Protocol Family)*

协议族主要有以下几类。通过 `socket` 函数的第一个参数传递。

|   名称    |        协议族        |
| :-------: | :------------------: |
|  PF_INET  |   IPv4互联网协议族   |
| PF_INET6  |   IPv6互联网协议族   |
| PF_LOCAL  | 本地通信的UNIX协议族 |
| PF_PACKET |  底层套接字的协议族  |
|  PF_IPX   |   IPX Novell协议族   |

> 本书将着重讲解IPv4互联网协议族（PF_INET）。

### 3. 套接字类型(Type)

决定了协议族并不能确定套接字的传输方式。

套接字类型指的是套接字的数据传输方式，通过 `socket` 函数的第二个参数传递。

#### *1. 面向连接的套接字(SOCK_STREAM)*

数据传输方式特征：

+ 传输过程中数据不会丢失
+ 按序传输数据
+ 传输的数据不存在数据边界

在面向连接的套接字中，`read`函数和`write`函数的调用次数并无太大意义。

可靠、有序、基于字节的面向连接的数据传输方式的套接字。套接字必须一一对应。这种套接字称为TCP套接字。

#### *2. 面向消息的套接字(SOCK_DGRAM)*

数据传输方式特征：

+ 强调快速传输而非传输顺序
+ 传输的数据可能丢失也可能损毁
+ 传输的数据有数据边界
+ 限制每次传输的数据大小

不可靠、无序、以数据的高速传输为目的的套接字。这种套接字成为UDP套接字。

#### *3. 协议的最终选择*

`socket` 函数的第三个参数决定最终采用的协议。传递前两个参数即可创建所需套接字，所以大部分情况下可以向第三个参数传递0，除非在同一协议族中存在多个数据传输方式相同的协议。这个时候，数据传输方式相同，协议不同，此时需要第三个参数具体指定协议信息。

在绝大多数实际开发（尤其是基于 IPv4 的网络编程）中，协议的选择是唯一的：

+ TCP 套接字：当选择 IPv4 协议族 (`PF_INET`) 且数据传输方式为面向连接 (SOCK_STREAM) 时，满足这两个条件的协议只有 `IPPROTO_TCP`。因此，完整的创建语句是：

```c
int tcp_socket = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);
```

+ UDP 套接字：当选择 IPv4 协议族 (`PF_INET`) 且数据传输方式为面向消息 (SOCK_DGRAM) 时，对应的协议只有 `IPPROTO_UDP`。创建语句为：

```c
int udp_socket = socket(PF_INET, SOCK_DGRAM, IPPROTO_UDP);
```

### *3. TCP套接字示例*

[tcp_client.c](./tcp_client.c)。该示例验证TCP套接字具有以下特性：传输的数据不存在边界。为验证这一点，需要让 `write` 函数的调用次数不同于 `read` 函数的调用次数。因此在客户端中分多次调用 `read` 函数以接收服务器端发送的全部数据。tcp_server.c 与第一章的hello_server.c相比无变化。
